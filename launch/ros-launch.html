<script> /**
 * @file ros-launch.html
 * @author Daniel Onderka (xonder05)
 * @date 10/2025
 */ </script>

<script type="text/javascript" src="resources/node-red-custom-nodes/log.js"></script>

<script type="text/javascript">

    RED.nodes.registerType("ros-launch", {
        category: "ROS2",
        color: "#E2D96E",
        defaults: {
            manager: {value: "", type: "manager-config"},
            package: {value: ""},
            launch_name: {value: ""},
            launch_args: {value: {}},
            launch_content: {value: ""},
        },
        inputs: 0,
        outputs: 1,
        icon: "file.png",
        label: function () {
            return this.launch_name || "ros-launch";
        },

        oneditprepare: async function () 
        {
            const node = this;

            const package_dropdown = $("#node-input-package");
            const launch_file_dropdown = $("#node-input-launch_name");
            const launch_file_content_dropdown = $("#node-input-launch_content");

            async function populate_package_dropdown()
            {
                // clear whatever used to be there
                package_dropdown.empty();

                // previously selected value
                const selected_package = node.package;

                // list of available packages
                const packages_list = await $.getJSON("ros-launch/list_packages");

                for (const package of packages_list)
                {
                    const selected = (package === selected_package) ? "selected" : "";
                    package_dropdown.append(`<option value="${package}" ${selected}>${package}</option>`);
                }
            }

            async function populate_launch_file_dropdown()
            {
                const selected_package = package_dropdown.val() ? package_dropdown.val() : node.package;

                launch_file_dropdown.empty();

                const selected_launch = node.launch_name;

                const launch_file_list = await $.getJSON(`ros-launch/list-launch?package=${encodeURIComponent(selected_package)}`);

                for (const launch_file of launch_file_list)
                {
                    const selected = (launch_file === selected_launch) ? "selected" : "";
                    launch_file_dropdown.append(`<option value="${launch_file}" ${selected}>${launch_file}</option>`);
                }
            }

            async function populate_launch_file_contents()
            {
                const selected_package = package_dropdown.val() ? package_dropdown.val() : node.package;
                const selected_launch_file_name = launch_file_dropdown.val() ? launch_file_dropdown.val() : node.launch_name;

                const launch_file_path = await $.getJSON(`ros-launch/get-full-launch-path?package_name=${encodeURIComponent(selected_package)}&launch_file_name=${selected_launch_file_name}`);
                const launch_file_content = await $.getJSON(`/ros-launch/get-file-content?file_path=${encodeURIComponent(launch_file_path)}`);

                launch_file_content_dropdown.val(launch_file_content);
            }

            $('#node-input-args_container').css('min-height','120px').css('min-width','450px').editableList(
            {
                addItem: function(container, i, opt)
                {
                    const arg = opt || {name: "", value: ""};

                    const row = $('<div/>')
                        .css({display: "flex", gap: "6px", alignItems: "center"})
                        .appendTo(container);

                    const key_input = $("<input/>", {
                        type: "text",
                        class: "node-input-arg-name",
                        placeholder: "key"
                    }).css({flex: "1"}).appendTo(row).val(arg.name);

                    const value_input = $("<input/>", {
                        type: "text",
                        class: "node-input-arg-value",
                        placeholder: "val"
                    }).css({flex: "1"}).appendTo(row).val(arg.value);
                    
                },
                removable: true,
            });

            async function populate_arguments_editable_list()
            {
                const selected_package = package_dropdown.val() ? package_dropdown.val() : node.package;
                const selected_launch_file_name = launch_file_dropdown.val() ? launch_file_dropdown.val() : node.launch_name;

                const launch_file_path = await $.getJSON(`ros-launch/get-full-launch-path?package_name=${encodeURIComponent(selected_package)}&launch_file_name=${selected_launch_file_name}`);

                const arguemnts_dict = await $.getJSON(`ros-launch/get-arguments?launch_file_path=${encodeURIComponent(launch_file_path)}`);

                $("#node-input-args_container").editableList('empty');
                for(const [arg, def] of Object.entries(arguemnts_dict))
                {
                    const value = node.launch_args[arg];

                    if (value) {
                        $("#node-input-args_container").editableList('addItem', {name: arg, value: value});
                    }
                    else {
                        $("#node-input-args_container").editableList('addItem', {name: arg, value: def});
                    }
                }
            }

            package_dropdown.on("change", populate_launch_file_dropdown);

            launch_file_dropdown.on("change", populate_launch_file_contents);

            launch_file_dropdown.on("change", populate_arguments_editable_list);
        
            await populate_package_dropdown();
        },

        oneditsave: function()
        {
            const node = this;

            const args = $("#node-input-args_container").editableList('items');
            node.launch_args = {};

            for (row of args)
            {
                const name = row.find('.node-input-arg-name').val();
                const value = row.find('.node-input-arg-value').val();

                if (name) {
                    node.launch_args[name] = value;
                }
            }
        },
    });
    
</script>

<script type="text/html" data-template-name="ros-launch">
    
    <div class="form-row">
        <label for="node-input-manager"><i class="fa fa-bookmark"></i> Port</label>
        <input type="text" id="node-input-manager">
    </div>

    <div class="form-row">
        <label for="node-input-package"><i class="fa fa-tag"></i> Package</label>
        <select id="node-input-package" placeholder="Package"></select>
    </div>

    <div class="form-row">
        <label for="node-input-launch_name"><i class="fa fa-tag"></i>Launch</label>
        <select id="node-input-launch_name" placeholder="Launch"></select>
    </div>

    <div class="form-row">
        <label for="node-input-launch_content"><i class="fa fa-tag"></i>Launch</label>
        <textarea id="node-input-launch_content"></textarea>
    </div>

    <div class="form-row">
        <label for="node-input-args_container"><i class="fa fa-bars"></i>Arguments</label>
        <ol id="node-input-args_container"></ol>
    </div>

</script>

<script type="text/html" data-help-name="ros-launch">
    <p>Node description</p>
</script>