<script> /**
 * @file ros-node.html
 * @author Daniel Onderka (xonder05)
 * @date 10/2025
 */ </script>

<script type="text/javascript" src="resources/node-red-custom-nodes/log.js"></script>

<script type="text/javascript">

    RED.nodes.registerType("ros-node",{
        category: "ROS2",
        color: "#F3B567",
        defaults: {
            manager: {value: "", type: "manager-config"},
            package: {value:""},
            node: {value:""},
            params: {value: {}},
            remaps: {value: {}},
        },
        inputs: 0,
        outputs: 1,
        icon: "file.svg",
        label: function() {
            return this.node || "ros-node";
        },

        oneditprepare: async function () 
        {
            const node = this;

            const package_dropdown = $("#node-input-package");
            const node_select = $("#node-input-node");

            async function populate_package_dropdown() 
            {
                package_dropdown.empty();

                // make sure to not erase previously selected value
                const selected_package = this.package;

                const packages_list = await $.getJSON("ros-node/list_packages");

                for (const package of packages_list)
                {
                    const selected = (package === selected_package) ? "selected" : "";
                    package_dropdown.append(`<option value="${package}" ${selected}>${package}</option>`);
                }
            }

            async function populate_node_dropdown(params) 
            {
                const selected_package = package_dropdown.val() ? package_dropdown.val() : this.package;

                node_select.empty();

                const selected_node = this.node;

                const node_list = await $.getJSON(`ros-node/list_nodes?package=${encodeURIComponent(selected_package)}`);

                for (const node of node_list) 
                {
                    const selected = (node === selected_node) ? "selected" : "";
                    node_select.append(`<option value="${node}" ${selected}>${node}</option>`);
                }
            }

            $('#node-input-params_container').css('min-height','120px').css('min-width','450px').editableList(
            {
                addItem: function(container, i, opt)
                {
                    const param = opt || {name: "", value: ""};

                    const row = $('<div/>')
                        .css({display: "flex", gap: "6px", alignItems: "center"})
                        .appendTo(container);

                    const key_input = $("<input/>", {
                        type: "text",
                        class: "node-input-param-name",
                        placeholder: "key"
                    }).css({flex: "1"}).appendTo(row).val(param.name);

                    const value_input = $("<input/>", {
                        type: "text",
                        class: "node-input-param-value",
                        placeholder: "val"
                    }).css({flex: "1"}).appendTo(row).val(param.value);
                    
                },
                removable: true,
            });

            $('#node-input-remaps_container').css('min-height','120px').css('min-width','450px').editableList(
            {
                addItem: function(container, i, opt)
                {
                    const remap = opt || {t1: "", t2: ""};

                    const row = $('<div/>')
                        .css({display: "flex", gap: "6px", alignItems: "center"})
                        .appendTo(container);

                    const key_input = $("<input/>", {
                        type: "text",
                        class: "node-input-remap-t1",
                        placeholder: "key"
                    }).css({flex: "1"}).appendTo(row).val(remap.t1);

                    const value_input = $("<input/>", {
                        type: "text",
                        class: "node-input-remap-t2",
                        placeholder: "val"
                    }).css({flex: "1"}).appendTo(row).val(remap.t2);
                    
                },
                removable: true,
            });

            // on package change update nodes list
            package_dropdown.on("change", populate_node_dropdown);

            await populate_package_dropdown();

            for(const [name, value] of Object.entries(node.params))
            {
                $("#node-input-params_container").editableList('addItem', {name: name, value: value});
            }

            for(const [t1, t2] of Object.entries(node.remaps))
            {
                $("#node-input-remaps_container").editableList('addItem', {t1: t1, t2: t2});
            }  
        },

        oneditsave: function()
        {
            const node = this;

            const params = $("#node-input-params_container").editableList('items');
            node.params = {};

            for (row of params)
            {
                const name = row.find('.node-input-param-name').val();
                const value = row.find('.node-input-param-value').val();

                if (name) {
                    node.params[name] = value;
                }
            }

            const remaps = $("#node-input-remaps_container").editableList('items');
            node.remaps = {};

            for (row of remaps)
            {
                const t1 = row.find('.node-input-remap-t1').val();
                const t2 = row.find('.node-input-remap-t2').val();

                if (t1) {
                    node.remaps[t1] = t2;
                }
            }
        },

    });

</script>

<script type="text/html" data-template-name="ros-node">
    
    <div class="form-row">
        <label for="node-input-manager"><i class="fa fa-bookmark"></i> Port</label>
        <input type="text" id="node-input-manager">
    </div>

    <div class="form-row">
        <label for="node-input-package"><i class="fa fa-tag"></i>Package</label>
        <select id="node-input-package" placeholder="Package"></select>
    </div>

    <div class="form-row">
        <label for="node-input-node"><i class="fa fa-tag"></i>Node</label>
        <select id="node-input-node" placeholder="Node"></select>
    </div>

    <div class="form-row">
        <label for="node-input-params_container"><i class="fa fa-bars"></i>Params</label>
        <ol id="node-input-params_container"></ol>
    </div>

    <div class="form-row">
        <label for="node-input-remaps_container"><i class="fa fa-bars"></i>Remaps</label>
        <ol id="node-input-remaps_container"></ol>
    </div>

</script>

<script type="text/html" data-help-name="ros-node">
    <p>Node description</p>
</script>